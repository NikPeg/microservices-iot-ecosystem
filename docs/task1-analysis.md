# Задание 1. Анализ и планирование

## 1. Анализ функциональности монолитного приложения

### Текущая функциональность

#### 1.1 Управление отоплением
- **Описание**: Пользователи могут удалённо включать/выключать отопление в своих домах
- **Реализация**: Через REST API endpoints для управления датчиками температуры
- **Ограничения**: Только базовое управление, отсутствует автоматизация и сценарии

#### 1.2 Мониторинг температуры
- **Описание**: Система получает данные о температуре с датчиков, установленных в домах
- **Реализация**: 
  - Внутренняя база данных для хранения информации о датчиках
  - Внешний Temperature API для получения актуальных данных
  - Web-интерфейс для просмотра текущей температуры
- **Функции**:
  - Получение списка всех датчиков
  - Получение данных конкретного датчика
  - Обновление значений датчиков
  - Создание/удаление/редактирование датчиков

## 2. Анализ архитектуры монолитного приложения

### 2.1 Технический стек
- **Язык программирования**: Go
- **База данных**: PostgreSQL
- **Web-фреймворк**: Gin
- **Контейнеризация**: Docker
- **Архитектурный паттерн**: Layered Architecture (Handler -> Service -> Database)

### 2.2 Структура приложения
```
smart_home/
├── main.go                    # Точка входа, инициализация сервера
├── handlers/                  # HTTP handlers (контроллеры)
│   └── sensors.go            # Обработка запросов к датчикам
├── services/                  # Бизнес-логика
│   └── temperature_service.go # Сервис для работы с внешним Temperature API
├── models/                    # Модели данных
│   └── sensor.go             # Модель датчика
├── db/                        # Слой доступа к данным
│   └── db.go                 # Database Access Layer
└── init.sql                  # Схема базы данных
```

### 2.3 Характеристики архитектуры

#### Сильные стороны:
- **Простота разработки**: Все компоненты в одном приложении
- **Простота развертывания**: Один исполняемый файл
- **Производительность**: Отсутствие сетевых вызовов между компонентами
- **Консистентность данных**: ACID транзакции в рамках одной БД
- **Отладка**: Легко отслеживать выполнение запросов

#### Слабые стороны:
- **Масштабируемость**: Ограничена, так как монолит сложно масштабировать по частям
- **Развертывание**: Требует остановки всего приложения для обновления
- **Технологическая гибкость**: Привязка к одному стеку технологий
- **Команды разработки**: Сложно распараллелить работу между командами
- **Отказоустойчивость**: Сбой одного компонента влияет на всю систему
- **Взаимодействие**: Синхронное, запросы обрабатываются последовательно

### 2.4 Текущая схема базы данных

```sql
CREATE TABLE sensors (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    location VARCHAR(100) NOT NULL,
    value FLOAT DEFAULT 0,
    unit VARCHAR(20),
    status VARCHAR(20) NOT NULL DEFAULT 'inactive',
    last_updated TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

**Ограничения текущей схемы**:
- Только один тип датчика (temperature)
- Отсутствует связь с пользователями/домами
- Нет поддержки устройств управления (реле, выключатели)
- Отсутствуют сценарии автоматизации

## 3. Определение доменов и границ контекстов (DDD)

### 3.1 Выявленные домены

#### 3.1.1 Домен "Управление Устройствами" (Device Management)
- **Ответственность**: Управление физическими устройствами (датчики, реле, выключатели)
- **Сущности**: Device, Sensor, Actuator, DeviceType
- **Операции**: Регистрация устройств, получение состояния, отправка команд

#### 3.1.2 Домен "Мониторинг и Телеметрия" (Monitoring & Telemetry)
- **Ответственность**: Сбор, хранение и анализ данных с датчиков
- **Сущности**: Measurement, MetricType, TimeSeriesData
- **Операции**: Сбор данных, агрегация, историческая аналитика

#### 3.1.3 Домен "Управление Пользователями" (User Management)
- **Ответственность**: Аутентификация, авторизация, профили пользователей
- **Сущности**: User, Role, Permission, Subscription
- **Операции**: Регистрация, аутентификация, управление правами доступа

#### 3.1.4 Домен "Управление Домами" (Home Management)
- **Ответственность**: Организация устройств по домам и комнатам
- **Сущности**: Home, Room, Location
- **Операции**: Создание структуры дома, привязка устройств к комнатам

#### 3.1.5 Домен "Автоматизация и Сценарии" (Automation & Scenarios)
- **Ответственность**: Создание и выполнение сценариев автоматизации
- **Сущности**: Scenario, Rule, Trigger, Action
- **Операции**: Создание сценариев, выполнение правил, обработка событий

#### 3.1.6 Домен "Уведомления" (Notifications)
- **Ответственность**: Отправка уведомлений пользователям
- **Сущности**: Notification, NotificationChannel, Alert
- **Операции**: Отправка уведомлений, управление каналами связи

### 3.2 Bounded Contexts (Ограниченные контексты)

1. **Device Context** - Управление устройствами
2. **Telemetry Context** - Сбор и анализ данных
3. **User Context** - Управление пользователями
4. **Home Context** - Структура домов
5. **Automation Context** - Сценарии автоматизации
6. **Notification Context** - Система уведомлений

### 3.3 Взаимодействие между контекстами

- **Device ↔ Telemetry**: Устройства отправляют данные в систему телеметрии
- **User ↔ Home**: Пользователи владеют домами
- **Home ↔ Device**: Дома содержат устройства
- **Automation ↔ Device**: Сценарии управляют устройствами
- **Telemetry ↔ Automation**: Данные телеметрии запускают сценарии
- **Notification ↔ User**: Уведомления отправляются пользователям

## 4. Рекомендации по переходу к микросервисной архитектуре

### 4.1 Приоритетные микросервисы для MVP
1. **Device Service** - Управление устройствами
2. **Telemetry Service** - Сбор и хранение данных
3. **User Service** - Управление пользователями
4. **Home Service** - Управление структурой домов
5. **Automation Service** - Базовые сценарии
6. **API Gateway** - Единая точка входа

### 4.2 Стратегия миграции
1. **Strangler Fig Pattern** - Постепенная замена функциональности
2. **Database per Service** - Выделение отдельных БД для каждого сервиса
3. **Event-Driven Architecture** - Асинхронное взаимодействие через события
4. **Circuit Breaker Pattern** - Повышение отказоустойчивости

### 4.3 Технологические решения
- **Message Broker**: Apache Kafka или RabbitMQ для асинхронного взаимодействия
- **Service Discovery**: Consul или Kubernetes DNS
- **Configuration Management**: Consul KV или Kubernetes ConfigMaps
- **Monitoring**: Prometheus + Grafana
- **Logging**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **Tracing**: Jaeger или Zipkin