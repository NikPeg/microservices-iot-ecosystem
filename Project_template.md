# Проектная работа 1 спринта - "Тёплый дом"

## Задание 1. Анализ и планирование

### 1.1 Анализ функциональности монолитного приложения

#### Текущая функциональность системы

**Управление отоплением:**
- Удалённое включение/выключение отопления через REST API
- Управление статусом отопительных устройств
- Базовые операции CRUD для управления датчиками

**Мониторинг температуры:**
- Сбор данных с температурных датчиков через внешний Temperature API
- Хранение информации о датчиках в PostgreSQL
- Веб-интерфейс для просмотра текущей температуры
- REST API для получения данных о температуре по местоположению

#### Ограничения текущей системы
- Поддержка только температурных датчиков
- Отсутствие системы пользователей и домов
- Нет автоматизации и сценариев
- Требуется выезд специалиста для подключения каждого датчика

### 1.2 Анализ архитектуры монолитного приложения

#### Технологический стек
- **Язык программирования:** Go
- **База данных:** PostgreSQL
- **Web-фреймворк:** Gin
- **Архитектурный паттерн:** Layered Architecture
- **Контейнеризация:** Docker

#### Структура приложения
```
smart_home/
├── main.go                    # Точка входа, инициализация
├── handlers/                  # HTTP обработчики
│   └── sensors.go            # API для работы с датчиками
├── services/                  # Бизнес-логика
│   └── temperature_service.go # Интеграция с внешним API
├── models/                    # Модели данных
│   └── sensor.go             # Модель датчика
├── db/                        # Слой доступа к данным
│   └── db.go                 # Database Access Layer
└── init.sql                  # Схема базы данных
```

#### Сильные стороны монолита
- **Простота разработки:** Все компоненты в одном приложении
- **Простота развертывания:** Один исполняемый файл
- **Производительность:** Отсутствие сетевых вызовов между компонентами
- **Консистентность данных:** ACID транзакции в рамках одной БД
- **Отладка:** Легко отслеживать выполнение запросов

#### Слабые стороны монолита
- **Масштабируемость:** Невозможно масштабировать компоненты независимо
- **Развертывание:** Требует остановки всего приложения для обновления
- **Технологическая гибкость:** Привязка к одному стеку технологий
- **Команды разработки:** Сложно распараллелить работу между командами
- **Отказоустойчивость:** Сбой одного компонента влияет на всю систему
- **Взаимодействие:** Только синхронная обработка запросов

### 1.3 Определение доменов и границ контекстов (DDD)

#### Выделенные Bounded Contexts

**1. Device Management (Управление устройствами)**
- **Ответственность:** Регистрация, управление и мониторинг IoT устройств
- **Ключевые сущности:** Device, Sensor, Actuator, DeviceType
- **Основные операции:** Регистрация устройств, отправка команд, мониторинг состояния

**2. Telemetry (Телеметрия и мониторинг)**
- **Ответственность:** Сбор, хранение и анализ данных с датчиков
- **Ключевые сущности:** Measurement, MetricType, TimeSeriesData, Alert
- **Основные операции:** Сбор данных, агрегация, генерация предупреждений

**3. User Management (Управление пользователями)**
- **Ответственность:** Аутентификация, авторизация, управление профилями
- **Ключевые сущности:** User, Role, Permission, Subscription
- **Основные операции:** Регистрация, аутентификация, управление подписками

**4. Home Management (Управление домами)**
- **Ответственность:** Организация устройств по домам и комнатам
- **Ключевые сущности:** Home, Room, Location, Floor
- **Основные операции:** Создание структуры дома, привязка устройств

**5. Automation (Автоматизация и сценарии)**
- **Ответственность:** Создание и выполнение сценариев автоматизации
- **Ключевые сущности:** Scenario, Rule, Trigger, Action, Schedule
- **Основные операции:** Создание сценариев, выполнение правил, обработка событий

**6. Notifications (Система уведомлений)**
- **Ответственность:** Отправка уведомлений пользователям
- **Ключевые сущности:** Notification, NotificationChannel, Alert, Template
- **Основные операции:** Отправка уведомлений, управление каналами связи

#### Context Map (Взаимодействие контекстов)
```
[User Management] ---> [Home Management] : Customer/Supplier
[Home Management] ---> [Device Management] : Customer/Supplier  
[Device Management] ---> [Telemetry] : Publisher/Subscriber
[Telemetry] ---> [Automation] : Publisher/Subscriber
[Automation] ---> [Device Management] : Customer/Supplier
[Automation] ---> [Notifications] : Customer/Supplier
[User Management] <--- [Notifications] : Customer/Supplier
```

### 1.4 Диаграмма контекста системы (C4 Model)

Создана диаграмма контекста в формате PlantUML, которая показывает:

**Внешние пользователи:**
- **Пользователь** - владелец умного дома
- **Администратор** - специалист по настройке системы

**Основная система:**
- **Smart Home Monolith** - текущее монолитное приложение

**Внешние системы:**
- **Temperature API** - внешний сервис для получения данных с датчиков
- **PostgreSQL Database** - база данных системы
- **Температурные датчики** - физические IoT устройства
- **Реле отопления** - исполнительные устройства

**Основные потоки взаимодействия:**
- Пользователи управляют системой через HTTPS/REST API
- Приложение получает данные от внешнего Temperature API
- Система отправляет команды на физические устройства
- Данные сохраняются в PostgreSQL

### 1.5 Рекомендации по переходу к микросервисной архитектуре

#### Целевая архитектура (MVP)
1. **Device Service** - управление устройствами и датчиками
2. **Telemetry Service** - сбор и хранение телеметрии
3. **User Service** - аутентификация и управление пользователями
4. **Home Service** - управление структурой домов
5. **Automation Service** - базовые сценарии автоматизации
6. **Notification Service** - система уведомлений
7. **API Gateway** - единая точка входа

#### Стратегия миграции: Strangler Fig Pattern
**Фаза 1:** Подготовка инфраструктуры
- Настройка CI/CD pipeline
- Развертывание мониторинга (Prometheus + Grafana)
- Создание API Gateway

**Фаза 2:** Выделение Device Service
- Миграция логики управления устройствами
- Создание отдельной базы данных
- Настройка межсервисного взаимодействия

**Фаза 3:** Последовательное выделение остальных сервисов
- User Service → Home Service → Telemetry Service → Automation Service → Notification Service

**Фаза 4:** Оптимизация и масштабирование
- Внедрение Event Sourcing
- Горизонтальное масштабирование
- Оптимизация производительности

#### Технологические решения
- **Message Broker:** Apache Kafka для асинхронного взаимодействия
- **Service Discovery:** Consul или Kubernetes DNS
- **Configuration Management:** Consul KV или ConfigMaps
- **Monitoring:** Prometheus + Grafana + Jaeger
- **Logging:** ELK Stack (Elasticsearch, Logstash, Kibana)
- **Databases:** PostgreSQL, MongoDB, InfluxDB (для телеметрии)

#### Архитектурные паттерны
- **Database per Service** - отдельная БД для каждого микросервиса
- **Event-Driven Architecture** - асинхронное взаимодействие через события
- **CQRS** - разделение команд и запросов для сложных доменов
- **Circuit Breaker** - повышение отказоустойчивости
- **Saga Pattern** - управление распределенными транзакциями

### 1.6 Ожидаемые результаты

#### Бизнес-преимущества
- **Масштабируемость:** Независимое масштабирование компонентов по нагрузке
- **Гибкость:** Быстрое внедрение новых функций и модулей
- **Надежность:** Изоляция отказов, graceful degradation
- **Time-to-Market:** Параллельная разработка разными командами

#### Технические преимущества
- **Технологическое разнообразие:** Оптимальный выбор технологий для каждой задачи
- **Независимое развертывание:** Обновления без остановки всей системы
- **Горизонтальное масштабирование:** Масштабирование по требованию
- **Улучшенная отказоустойчивость:** Система продолжает работать при сбоях отдельных компонентов

## Заключение по Заданию 1

Проведенный анализ показал, что текущая монолитная архитектура не соответствует требованиям масштабируемой экосистемы умных домов. Применение принципов Domain-Driven Design позволило выделить 6 четких доменных границ, которые станут основой для микросервисной архитектуры.

Предложенная стратегия поэтапной миграции с использованием Strangler Fig Pattern минимизирует риски и обеспечивает плавный переход к целевой архитектуре. Внедрение event-driven подхода и современных инфраструктурных решений позволит создать масштабируемую, надежную и гибкую систему, соответствующую бизнес-целям компании "Тёплый дом".

---

**Файлы документации:**
- `docs/task1-analysis.md` - детальный анализ текущей системы
- `docs/domain-analysis.md` - анализ доменов с применением DDD
- `docs/c4-context-diagram.puml` - диаграмма контекста системы
- `docs/task1-summary.md` - итоговый отчет и рекомендации
- `docs/README.md` - руководство по работе с документацией